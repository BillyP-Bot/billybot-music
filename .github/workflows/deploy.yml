name: deploy

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: self-hosted
    environment: raspberry pi 5
    env:
      APP_DIR: /home/pi/apps/billybot-music

    steps:
    - uses: actions/checkout@v2
    
    - name: Create app directory if it doesn't exist
      run: 

    - name: Copy project files to app directory
      run: |
        mkdir -p $APP_DIR
        cp -rf ./{*,.[^.]*} $APP_DIR/ 2>/dev/null || true

    - name: Configure app environment
      run: |
        cd $APP_DIR
        pyenv local 3.10.2
        source myenv/bin/activate
        pip install -r config/requirements.txt

    - name: Launch app in 'dj' tmux session
      run: |
        cd $APP_DIR
        tmux kill-session -t dj 2>/dev/null || true
        tmux new-session -d -s dj 'python run.py'
        tmux has-session -t dj
